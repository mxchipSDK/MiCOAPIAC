<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,user-scalable=0">
		<title>APICloud</title>
		<script type="text/javascript" src="../script/jquery-2.1.3.js"></script>
		<style>
			.ipbutton {
				width: 150px;
				height: 25px;
				background: #D0EEFF;
				border: 1px solid #99D3F5;
				border-radius: 4px;
				color: #0D4A09;
				margin-top: 10px;
			}
		</style>
		<script type="text/javascript">
			var micoMqtt;
			apiready = function() {
				micoMqtt = api.require("MiCO");
			};

			function getSSID() {
				micoMqtt.getSSID(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function onlyStopEasyLink() {
				micoMqtt.onlyStopEasyLink(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function startEasyLink() {
				micoMqtt.startEasyLink({
					wifi_ssid : "mxchip",
					wifi_password : "88888888"
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopEasyLink() {
				micoMqtt.stopEasyLink(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function startMqtt() {
				var topic = "d64f517c/c8934691813c/out/read";
				var host = "api.easylink.io";
				var port = "1883";
				var username = $("#admin").val();
				var password = "admin";
				var clientID = "clientId-999abcdedf";

				micoMqtt.startMqtt({
					micoMqtt : micoMqtt,
					host : host,
					port : port,
					username : username,
					password : password,
					clientID : clientID,
					topic : topic
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopMqtt() {
				micoMqtt.stopMqtt(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function recvMqttMsg() {
				micoMqtt.recvMqttMsg(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopRecvMqttMsg() {
				micoMqtt.stopRecvMqttMsg(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function startMDNS() {
				var servicename = "_easylink._tcp.local.";
				micoMqtt.startMDNS({
					servicename:servicename
				},function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopMDNS() {
				micoMqtt.stopMDNS(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function publishCommand(type) {
				var command;
				if (1 == type) {
					command = '{"4":true}';
				} else {
					command = '{"4":false}';
				}
				var topic = "d64f517c/c8934691813c/in/write";
				var qos = 0;
				var retained = false;
				micoMqtt.publishCommand({
					topic : topic,
					command : command,
					qos : qos,
					retained : retained
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function addSubscribe() {
				var topic = "d64f517c/c8934691813c/out/err";
				var qos = 0;
				micoMqtt.addSubscribe({
					topic : topic,
					qos : qos
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function rmSubscribe() {
				var topic = "d64f517c/c8934691813c/out/err";
				micoMqtt.rmSubscribe({
					topic : topic
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

		</script>
	</head>
	<body>
		<br/>
		<br/>
		<br/>
		<input class="ipbutton" type="button" value="获取ssid"  onclick="getSSID();"/>
		<br/>
		<input class="ipbutton" type="button" value="开启配网"  onclick="startEasyLink();"/>
		<br/>
		<input class="ipbutton" type="button" value="不发包"  onclick="onlyStopEasyLink();"/>
		<br/>
		<input class="ipbutton" type="button" value="关闭配网"  onclick="stopEasyLink();"/>
		<br/>
		<br/>
		<input type="text" value="admin" id="admin"/>
		<br/>
		<input class="ipbutton" type="button" value="打开MQTT"  onclick="startMqtt();"/>
		<br/>
		<input class="ipbutton" type="button" value="关闭MQTT"  onclick="stopMqtt();"/>
		<br/>
		<input class="ipbutton" type="button" value="开始接收消息"  onclick="recvMqttMsg();"/>
		<br/>
		<input class="ipbutton" type="button" value="停止接收消息"  onclick="stopRecvMqttMsg();"/>
		<br/>
		<input class="ipbutton" type="button" value="开灯"  onclick="publishCommand(1);"/>
		<input class="ipbutton" type="button" value="关灯"  onclick="publishCommand(0);"/>
		<br/>
		<input class="ipbutton" type="button" value="增加订阅"  onclick="addSubscribe();"/>
		<br/>
		<input class="ipbutton" type="button" value="减少订阅"  onclick="rmSubscribe();"/>
		<br/>
		<br/>
		<input class="ipbutton" type="button" value="打开MDNS"  onclick="startMDNS();"/>
		<br/>
		<input class="ipbutton" type="button" value="关闭MDNS"  onclick="stopMDNS();"/>
		<div data-role="content">
			<ul id="messEdits"></ul>
		</div>
	</body>
</html>