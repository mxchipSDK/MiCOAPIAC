<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,user-scalable=0">
		<title>APICloud</title>
		<script type="text/javascript" src="../script/jquery-2.1.3.js"></script>
		<script type="text/javascript">
			var micoMqtt;
			apiready = function() {
				micoMqtt = api.require("MiCO");
			};

			function getSSID() {
				alert(micoMqtt);
				micoMqtt.getSSID(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function onlyStopEasyLink() {
				micoMqtt.onlyStopEasyLink();
			}

			function startEasyLink() {
				micoMqtt.startEasyLink({
					wifi_ssid : "mxchip",
					wifi_password : "88888888"
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopEasyLink() {
				micoMqtt.stopEasyLink(function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function startMqtt() {
				alert("MiCOBindAPI");

				var topic = "d64f517c/c8934691813c/out/read";
				var host = "api.easylink.io";
				var port = "1883";
				var username = $("#admin").val();
				var password = "admin";
				var clientID = "clientId-999abcdedf";

				micoMqtt.startMqtt({
					micoMqtt : micoMqtt,
					host : host,
					port : port,
					username : username,
					password : password,
					clientID : clientID,
					topic : topic
				}, function(ret, err) {
					var html;
					if (ret)
						html = "<li><div>ret-->" + JSON.stringify(ret) + "</div></li>";
					else
						html = "<li><div>err-->" + JSON.stringify(err) + "</div></li>";
					$("#messEdits").prepend(html);
				});
			}

			function stopMqtt() {
				micoMqtt.stopMqtt();
			}

			function recvMqttMsg() {
				micoMqtt.recvMqttMsg();
			}

			function stopRecvMqttMsg() {
				micoMqtt.stopRecvMqttMsg();
			}

			function publishCommand() {
				var topic = "d64f517c/c8934691813c/in/write";
				var command = '{"4":true}';
				var qos = 0;
				var retained = false;
				micoMqtt.publishCommand({
					topic : topic,
					command : command,
					qos : qos,
					retained : retained
				});
			}

			function addSubscribe() {
				var topic = "d64f517c/c8934691813c/out/err";
				var qos = 0;
				micoMqtt.addSubscribe({
					topic : topic,
					qos : qos
				});
			}

			function rmSubscribe() {
				var topic = "d64f517c/c8934691813c/out/err";
				micoMqtt.rmSubscribe({
					topic : topic
				});
			}

		</script>
	</head>
	<body>
		<br/>
		<br/>
		<br/>
		<input type="button" value="获取ssid"  onclick="getSSID();"/>
		<br/>
		<input type="button" value="开启配网"  onclick="startEasyLink();"/>
		<br/>
		<input type="button" value="不发包"  onclick="onlyStopEasyLink();"/>
		<br/>
		<input type="button" value="关闭配网"  onclick="stopEasyLink();"/>
		<br/>
		<br/>
		<input type="text" value="admin" id="admin"/>
		<br/>
		<input type="button" value="打开MQTT"  onclick="startMqtt();"/>
		<br/>
		<input type="button" value="关闭MQTT"  onclick="stopMqtt();"/>
		<br/>
		<input type="button" value="开始接收消息"  onclick="recvMqttMsg();"/>
		<br/>
		<input type="button" value="停止接收消息"  onclick="stopRecvMqttMsg();"/>
		<br/>
		<input type="button" value="发送指令"  onclick="publishCommand();"/>
		<br/>
		<input type="button" value="增加订阅"  onclick="addSubscribe();"/>
		<br/>
		<input type="button" value="减少订阅"  onclick="rmSubscribe();"/>
		<div data-role="content">
			<ul id="messEdits"></ul>
		</div>
	</body>
</html>